<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captain</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    .panel { background:#11172B; border:1px solid #1B2440; padding:16px; margin:12px; border-radius:8px; }
    button { margin-top:12px; padding:8px 12px; background:#26406E; border:none; color:#D7E3FF; border-radius:6px; }
    .row { display:flex; gap:12px; align-items:center; }
    .pip { width:10px; height:10px; border-radius:50%; display:inline-block; margin-left:6px; }
    .on { background:#8BE28B; box-shadow:0 0 8px rgba(139,226,139,0.6); }
    .off { background:#E26969; box-shadow:0 0 8px rgba(226,105,105,0.6); }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Captain</h2>
    <div class="row">
      <button id="consent" title="Grant temporary firing consent for interlocked weapons">Toggle Fire Consent</button>
      <span title="Periscope raised increases detection risk">Periscope <span id="periscope" class="pip off"></span></span>
      <button id="periscopeBtn" title="Raise/lower periscope">Raise/Lower</button>
      <span title="Radio mast raised increases EMCON risk">Radio <span id="radio" class="pip off"></span></span>
      <button id="radioBtn" title="Raise/lower radio mast">Raise/Lower</button>
    </div>
    <div class="row">
      <div class="pill">EMCON: <span id="emcon">low</span></div>
      <div class="pill">Noise: <span id="noise">0</span></div>
    </div>
    <div class="panel">
      <h3>Mission Brief</h3>
      <div class="pill" id="briefTitle"></div>
      <div class="label" id="briefObj"></div>
      <div class="label">ROE:</div>
      <ul id="roe"></ul>
    </div>
    <div class="panel">
      <h3>Communications</h3>
      <div class="label">Raise radio mast at ≤20m to receive scheduled comms.</div>
      <ul id="comms"></ul>
    </div>
    <div class="panel">
      <h3>Station Status</h3>
      <div class="row">
        <div class="pill" id="stHelm">Helm: OK</div>
        <div class="pill" id="stSonar">Sonar: OK</div>
        <div class="pill" id="stWeapons">Weapons: OK</div>
        <div class="pill" id="stEng">Engineering: OK</div>
      </div>
    </div>
    <div class="panel">
      <h3>Periscope Contacts</h3>
      <ul id="scope"></ul>
    </div>
    <pre id="telemetry" title="Captain telemetry and events"></pre>
  </div>
  <script>
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/captain');
    const tel = document.getElementById('telemetry');
    const per = document.getElementById('periscope');
    const rad = document.getElementById('radio');
    const emcon = document.getElementById('emcon');
    const noise = document.getElementById('noise');
    function setPip(el, val){ el.className = 'pip ' + (val ? 'on' : 'off'); }
    function setStatus(el, label){
      el.textContent = label;
      if (label.includes('Failed')){ el.style.color = '#EF4444'; el.style.borderColor = '#EF4444'; el.style.backgroundColor = 'rgba(239,68,68,0.1)'; }
      else if (label.includes('Degraded')){ el.style.color = '#F59E0B'; el.style.borderColor = '#F59E0B'; el.style.backgroundColor = 'rgba(245,158,11,0.1)'; }
      else { el.style.color = '#8DEB8D'; el.style.borderColor = '#1B2440'; el.style.backgroundColor = '#0F162A'; }
    }
    ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if (m.topic === 'telemetry') { tel.textContent = JSON.stringify(m.data, null, 2); setPip(per, !!m.data.periscopeRaised); setPip(rad, !!m.data.radioRaised); if (m.data.acoustics){ emcon.textContent = m.data.acoustics.emconRisk || 'low'; noise.textContent = (m.data.acoustics.noiseBudget || 0).toFixed(0);} const mission = m.data.mission || {}; document.getElementById('briefTitle').textContent = mission.title || ''; document.getElementById('briefObj').textContent = mission.objective || ''; const roe = mission.roe || []; const ul = document.getElementById('roe'); ul.innerHTML = ''; roe.forEach(r => { const li=document.createElement('li'); li.textContent = r; ul.appendChild(li); }); const comms = m.data.comms || []; const cu = document.getElementById('comms'); const seen = new Set(Array.from(cu.querySelectorAll('li')).map(li=>li.dataset.key)); comms.forEach(c => { const key = (c.at + c.text); if (!seen.has(key)) { const li=document.createElement('li'); li.dataset.key = key; li.textContent = `${c.at} - ${c.text}`; cu.appendChild(li);} }); const ss = m.data.stationStatus || {}; setStatus(document.getElementById('stHelm'), `Helm: ${ss.helm || 'OK'}`); setStatus(document.getElementById('stSonar'), `Sonar: ${ss.sonar || 'OK'}`); setStatus(document.getElementById('stWeapons'), `Weapons: ${ss.weapons || 'OK'}`); setStatus(document.getElementById('stEng'), `Engineering: ${ss.engineering || 'OK'}`); const scope = document.getElementById('scope'); scope.innerHTML = ''; (m.data.periscopeContacts||[]).forEach(c => { const li=document.createElement('li'); const km=(c.range_m/1000).toFixed(2); li.textContent = `${c.id} ${c.type} brg ${c.bearing.toFixed(0)}° range ${km} km speed ${(+c.speed_kn).toFixed(1)} kn`; scope.appendChild(li); }); } } catch(e){} };
    document.getElementById('consent').onclick = () => { ws.send(JSON.stringify({topic:'captain.consent', data:{consent:true}})); setTimeout(()=>ws.send(JSON.stringify({topic:'captain.consent', data:{consent:false}})), 3000); };
    document.getElementById('periscopeBtn').onclick = () => { const next = per.classList.contains('off'); ws.send(JSON.stringify({topic:'captain.periscope.raise', data:{raised: next}})); };
    document.getElementById('radioBtn').onclick = () => { const next = rad.classList.contains('off'); ws.send(JSON.stringify({topic:'captain.radio.raise', data:{raised: next}})); };
  </script>
</body>
</html>
