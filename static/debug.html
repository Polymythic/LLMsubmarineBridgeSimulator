<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug Map</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    .panel { background:#11172B; border:1px solid #1B2440; padding:16px; margin:12px; border-radius:8px; }
    canvas { width:100%; height:420px; background:#050814; border:1px solid #1B2440; border-radius:6px; }
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    .pill { padding:4px 8px; border-radius:12px; background:#0F162A; border:1px solid #1B2440; margin:4px 0; }
    .pill[id="wsStatus"] { display: inline-block; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Debug <span class="pill" id="wsStatus" title="WebSocket connection status" style="margin-left: 8px; font-size: 14px; font-weight: normal;">WebSocket: Connecting...</span></h2>
    <div class="row" style="align-items:center">
      <button id="restart" title="Reset mission state to defaults">Restart Mission</button>
      <div>
        <label for="mission">Mission:</label>
        <select id="mission" title="Select mission scenario">
          <option value="patrol">Patrol - Blue vs Single Red</option>
          <option value="ambush">Ambush - Two Reds Ahead</option>
          <option value="convoy">Convoy Escort</option>
          <option value="surface_vessel" selected>Surface Vessel (Training)</option>
        </select>
      </div>
      <div class="pill" style="margin-left: 8px;">
        Maint Spawns: <span id="maintState">ON</span>
        <button id="toggleMaint" style="margin-left:8px;">Toggle</button>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <canvas id="map" width="720" height="420" title="Ownship-centered truth positions"></canvas>
      </div>
      <div class="col">
        <div class="pill">Ownship: <span id="own"></span></div>
        <div id="list"></div>
      </div>
    </div>
  </div>
  <script>
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/debug');
    
    // WebSocket connection status
    const wsStatus = document.getElementById('wsStatus');
    
    ws.onopen = () => {
        wsStatus.textContent = 'WebSocket: Connected';
        wsStatus.style.color = '#8DEB8D';
        wsStatus.style.borderColor = '#8DEB8D';
    };
    
    ws.onclose = () => {
        wsStatus.textContent = 'WebSocket: Disconnected';
        wsStatus.style.color = '#FF6B6B';
        wsStatus.style.borderColor = '#FF6B6B';
    };
    
    ws.onerror = (error) => {
        wsStatus.textContent = 'WebSocket: Error';
        wsStatus.style.color = '#FF6B6B';
        wsStatus.style.borderColor = '#FF6B6B';
    };
    const map = document.getElementById('map');
    const ctx = map.getContext('2d');
    const W = map.width, H = map.height;
    const ownEl = document.getElementById('own');
    const list = document.getElementById('list');

    function drawShip(x,y,heading,color,label){
      ctx.save();
      ctx.translate(x,y);
      // Canvas default points to +X (east). Our headings are compass (0=N,90=E,180=S,270=W).
      // Map compass to canvas by rotating (90 - heading) degrees.
      ctx.rotate((90 - heading) * Math.PI/180);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(16,0); ctx.lineTo(-10,6); ctx.lineTo(-10,-6); ctx.closePath();
      ctx.fill();
      ctx.restore();
      ctx.fillStyle = '#89B4FA';
      ctx.fillText(label, x+8, y-8);
    }

    function render(data){
      // Center on ownship, scale to include all ships with padding
      const cx = data.ownship.x, cy = data.ownship.y;
      const pad = 200;
      let maxDx = 100, maxDy = 100;
      data.ships.forEach(s => { maxDx = Math.max(maxDx, Math.abs(s.x - cx)); maxDy = Math.max(maxDy, Math.abs(s.y - cy)); });
      const spanX = maxDx * 2 + pad;
      const spanY = maxDy * 2 + pad;
      function worldToScreen(wx, wy){
        const sx = (wx - cx) / spanX * (W*0.8) + W/2;
        const sy = (wy - cy) / spanY * (H*0.8) + H/2;
        return [sx, sy];
      }
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = '#050814'; ctx.fillRect(0,0,W,H);
      ctx.strokeStyle = '#1B2440'; ctx.lineWidth = 1;
      for(let i=0;i<8;i++){ ctx.beginPath(); ctx.moveTo(0, i*H/8); ctx.lineTo(W, i*H/8); ctx.stroke(); }
      for(let i=0;i<12;i++){ ctx.beginPath(); ctx.moveTo(i*W/12, 0); ctx.lineTo(i*W/12, H); ctx.stroke(); }

      // Ownship fixed at center
      const [ox, oy] = worldToScreen(data.ownship.x, data.ownship.y);
      drawShip(ox, oy, data.ownship.heading, '#6EE7A7', `OWN hdg ${data.ownship.heading.toFixed(0)} spd ${data.ownship.speed.toFixed(1)} dpt ${data.ownship.depth.toFixed(0)}`);

      // Enemies
      list.innerHTML = '';
      data.ships.forEach(s => {
        const [sx, sy] = worldToScreen(s.x, s.y);
        drawShip(sx, sy, s.heading, '#E87979', `${s.id}`);
        // Bearing line from ownship
        ctx.strokeStyle = '#E87979';
        ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(sx, sy); ctx.stroke();
        const li = document.createElement('div');
        li.className = 'pill';
        const bTrue = (s.bearing_true ?? 0).toFixed(0);
        const bRel = (s.bearing_rel ?? 0).toFixed(0);
        const rng = (s.range_from_own ?? 0).toFixed(0);
        const det = Math.round(((s.passiveDetect || 0) * 100));
        li.textContent = `${s.id} hdg ${s.heading.toFixed(0)} spd ${s.speed.toFixed(1)} dpt ${s.depth.toFixed(0)} brgT ${bTrue} brgR ${bRel} rng ${rng} detect ${det}%`;
        // Color pip based on detectability
        if (det >= 70) { li.style.color = '#FF6B6B'; }
        else if (det >= 40) { li.style.color = '#FACC15'; }
        else { li.style.color = '#8DEB8D'; }
        li.title = `Passive detect: ${det}%  | snrDb: ${((s.snrDb||0)).toFixed(1)}`;
        list.appendChild(li);
      });
    }

    ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if (m.topic === 'telemetry') { ownEl.textContent = `hdg ${m.data.ownship.heading.toFixed(0)} spd ${m.data.ownship.speed.toFixed(1)} dpt ${m.data.ownship.depth.toFixed(0)}`; render(m.data); const maint = (m.data.maintenance && typeof m.data.maintenance.spawnsEnabled === 'boolean') ? m.data.maintenance.spawnsEnabled : true; const maintState = document.getElementById('maintState'); maintState.textContent = maint ? 'ON' : 'OFF'; maintState.style.color = maint ? '#8DEB8D' : '#FF6B6B'; } } catch(e){} };
    document.getElementById('restart').onclick = () => {
      const sel = document.getElementById('mission');
      const mission = sel && sel.value ? sel.value : 'patrol';
      if (mission === 'surface_vessel') {
        ws.send(JSON.stringify({topic:'debug.mission.surface_vessel', data:{}}));
      } else if (mission === 'patrol') {
        ws.send(JSON.stringify({topic:'debug.restart', data:{}}));
      } else if (mission === 'ambush') {
        // Not implemented yet; fallback to default reset
        ws.send(JSON.stringify({topic:'debug.restart', data:{}}));
      } else if (mission === 'convoy') {
        // Not implemented yet; fallback to default reset
        ws.send(JSON.stringify({topic:'debug.restart', data:{}}));
      } else {
        ws.send(JSON.stringify({topic:'debug.restart', data:{}}));
      }
    };
    document.getElementById('toggleMaint').onclick = () => {
      const isOn = (document.getElementById('maintState').textContent || 'ON') === 'ON';
      const next = !isOn;
      ws.send(JSON.stringify({topic:'debug.maintenance.spawns', data:{enabled: next}}));
    };
  </script>
</body>
</html>
