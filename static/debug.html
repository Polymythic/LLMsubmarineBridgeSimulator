<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug Map</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    .panel { background:#11172B; border:1px solid #1B2440; padding:16px; margin:12px; border-radius:8px; }
    canvas { width:100%; height:420px; background:#050814; border:1px solid #1B2440; border-radius:6px; }
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    .pill { padding:4px 8px; border-radius:12px; background:#0F162A; border:1px solid #1B2440; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Debug</h2>
    <div class="row">
      <div class="col">
        <canvas id="map" width="720" height="420" title="Ownship and contacts truth positions"></canvas>
      </div>
      <div class="col">
        <div class="pill">Ownship: <span id="own"></span></div>
        <div id="list"></div>
      </div>
    </div>
  </div>
  <script>
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/debug');
    const map = document.getElementById('map');
    const ctx = map.getContext('2d');
    const W = map.width, H = map.height;
    const ownEl = document.getElementById('own');
    const list = document.getElementById('list');

    function drawShip(x,y,heading,color,label){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(heading * Math.PI/180);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(16,0); ctx.lineTo(-10,6); ctx.lineTo(-10,-6); ctx.closePath();
      ctx.fill();
      ctx.restore();
      ctx.fillStyle = '#89B4FA';
      ctx.fillText(label, x+8, y-8);
    }

    function render(data){
      // Compute bounds from ships to auto-scale
      const all = [{x:data.ownship.x, y:data.ownship.y}, ...data.ships.map(s=>({x:s.x,y:s.y}))];
      const xs = all.map(p=>p.x), ys = all.map(p=>p.y);
      const minx = Math.min(...xs), maxx = Math.max(...xs), miny = Math.min(...ys), maxy = Math.max(...ys);
      const pad = 200;
      const spanX = Math.max(100, (maxx-minx)||100) + pad;
      const spanY = Math.max(100, (maxy-miny)||100) + pad;
      const centerX = (minx+maxx)/2, centerY = (miny+maxy)/2;
      function worldToScreen(wx, wy){
        const sx = (wx - centerX) / spanX * (W*0.8) + W/2;
        const sy = (wy - centerY) / spanY * (H*0.8) + H/2;
        return [sx, sy];
      }
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = '#050814'; ctx.fillRect(0,0,W,H);
      ctx.strokeStyle = '#1B2440';
      for(let i=0;i<8;i++){ ctx.beginPath(); ctx.moveTo(0, i*H/8); ctx.lineTo(W, i*H/8); ctx.stroke(); }
      for(let i=0;i<12;i++){ ctx.beginPath(); ctx.moveTo(i*W/12, 0); ctx.lineTo(i*W/12, H); ctx.stroke(); }

      // Ownship
      const [ox, oy] = worldToScreen(data.ownship.x, data.ownship.y);
      drawShip(ox, oy, data.ownship.heading, '#6EE7A7', `OWN hdg ${data.ownship.heading.toFixed(0)} spd ${data.ownship.speed.toFixed(1)} dpt ${data.ownship.depth.toFixed(0)}`);

      // Enemies
      list.innerHTML = '';
      data.ships.forEach(s => {
        const [sx, sy] = worldToScreen(s.x, s.y);
        drawShip(sx, sy, s.heading, '#E87979', `${s.id}`);
        // Bearing line from ownship
        ctx.strokeStyle = '#E87979';
        ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(sx, sy); ctx.stroke();
        const li = document.createElement('div');
        li.className = 'pill';
        li.textContent = `${s.id} hdg ${s.heading.toFixed(0)} spd ${s.speed.toFixed(1)} dpt ${s.depth.toFixed(0)} brg ${(s.bearing_from_own||0).toFixed(0)} rng ${((s.range_from_own||0)).toFixed(0)}`;
        list.appendChild(li);
      });
    }

    ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if (m.topic === 'telemetry') { ownEl.textContent = `hdg ${m.data.ownship.heading.toFixed(0)} spd ${m.data.ownship.speed.toFixed(1)} dpt ${m.data.ownship.depth.toFixed(0)}`; render(m.data); } } catch(e){} };
  </script>
</body>
</html>
