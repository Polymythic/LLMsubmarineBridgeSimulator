<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Engineering</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    .panel { background:#11172B; border:1px solid #1B2440; padding:16px; margin:12px; border-radius:8px; }
    input[type=range] { width:100%; }
    button { margin-top:12px; padding:8px 12px; background:#26406E; border:none; color:#D7E3FF; border-radius:6px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .pill { padding:4px 8px; border-radius:12px; background:#0F162A; border:1px solid #1B2440; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Engineering</h2>
    <div id="toast" style="position:fixed;top:8px;right:8px;background:#2B0F14;color:#FFD1D1;border:1px solid #5F1B25;padding:8px 12px;border-radius:6px;display:none;">Error</div>
    <div title="Reactor output and SCRAM state">Reactor MW <span id="mwv">60</span> / <span id="mwmax">100</span> <span class="pill" id="scramState">SCRAM: OFF</span></div>
    <input id="mw" type="range" min="0" max="100" step="1" value="60" title="Adjust reactor power (MW)" />
    <div class="row">
      <button id="set" title="Set reactor power to slider value">Set MW</button>
      <button id="scram" title="Trip reactor SCRAM (emergency shutdown)">Toggle SCRAM</button>
      <button id="pumpF" title="Toggle forward pump to reduce flooding">Toggle Pump FWD</button>
      <button id="pumpA" title="Toggle aft pump to reduce flooding">Toggle Pump AFT</button>
    </div>
    <div class="row">
      <div class="pill" id="task" title="Current maintenance task for Engineering">No active task</div>
      <button id="repair" title="Start repairing the active engineering task">Repair</button>
    </div>
    <div class="panel">
      <h3>Current Power Allocation</h3>
      <div class="row">
        <div>Helm: <input id="cHelm" type="range" min="0" max="1" step="0.01" value="0.25" disabled /> <span class="pill" id="cHelmPct">25%</span></div>
        <div>Weapons: <input id="cWeapons" type="range" min="0" max="1" step="0.01" value="0.25" disabled /> <span class="pill" id="cWeaponsPct">25%</span></div>
        <div>Sonar: <input id="cSonar" type="range" min="0" max="1" step="0.01" value="0.25" disabled /> <span class="pill" id="cSonarPct">25%</span></div>
        <div>Engineering: <input id="cEng" type="range" min="0" max="1" step="0.01" value="0.25" disabled /> <span class="pill" id="cEngPct">25%</span></div>
      </div>
      <div class="row"><div class="pill">Total: <span id="cTotal">100%</span></div></div>
    </div>

    <div class="panel">
      <h3>Proposed Power Allocation</h3>
      <div class="row">
        <div>Helm: <input id="pHelm" type="range" min="0" max="1" step="0.05" value="0.25" /> <span class="pill" id="pHelmPct">25%</span></div>
        <div>Weapons: <input id="pWeapons" type="range" min="0" max="1" step="0.05" value="0.25" /> <span class="pill" id="pWeaponsPct">25%</span></div>
        <div>Sonar: <input id="pSonar" type="range" min="0" max="1" step="0.05" value="0.25" /> <span class="pill" id="pSonarPct">25%</span></div>
        <div>Engineering: <input id="pEng" type="range" min="0" max="1" step="0.05" value="0.25" /> <span class="pill" id="pEngPct">25%</span></div>
      </div>
      <div class="row">
        <div class="pill">Total: <span id="pTotal">100%</span></div>
        <div class="pill">Unallocated: <span id="pUnalloc">0%</span></div>
        <span id="pErr" style="color:#FF6B6B"></span>
      </div>
      <button id="applyAlloc" title="Apply power allocations (must not exceed 100%)">Apply Allocation</button>
    </div>
    <div class="row">
      <div class="pill">Rudder: <span id="rudderOk">OK</span></div>
      <div class="pill">Ballast: <span id="ballastOk">OK</span></div>
      <div class="pill">Sonar: <span id="sonarOk">OK</span></div>
      <div class="pill">Radio: <span id="radioOk">OK</span></div>
      <div class="pill">Periscope: <span id="periscopeOk">OK</span></div>
      <div class="pill">Tubes: <span id="tubesOk">OK</span></div>
    </div>
    <div class="row">
      <div class="pill" title="Battery state of charge">Battery: <span id="bat">100</span>%</div>
      <div class="pill" title="Flooding rate; pumps reduce this">Flooding rate: <span id="flood">0</span></div>
      <div class="pill" title="Overall hull damage fraction">Hull dmg: <span id="hull">0</span></div>
    </div>
    <pre id="telemetry" title="Engineering telemetry and events"></pre>
  </div>
  <script>
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/engineering');
    const tel = document.getElementById('telemetry');
    const mw = document.getElementById('mw');
    const mwv = document.getElementById('mwv');
    const mwmax = document.getElementById('mwmax');
    const bat = document.getElementById('bat');
    const flood = document.getElementById('flood');
    const hull = document.getElementById('hull');
    const scramState = document.getElementById('scramState');
    const pHelm = document.getElementById('pHelm');
    const pWeapons = document.getElementById('pWeapons');
    const pSonar = document.getElementById('pSonar');
    const pEng = document.getElementById('pEng');
    const pHelmPct = document.getElementById('pHelmPct');
    const pWeaponsPct = document.getElementById('pWeaponsPct');
    const pSonarPct = document.getElementById('pSonarPct');
    const pEngPct = document.getElementById('pEngPct');
    const pTotal = document.getElementById('pTotal');
    const pErr = document.getElementById('pErr');
    const pUnalloc = document.getElementById('pUnalloc');
    const cHelm = document.getElementById('cHelm');
    const cWeapons = document.getElementById('cWeapons');
    const cSonar = document.getElementById('cSonar');
    const cEng = document.getElementById('cEng');
    const cHelmPct = document.getElementById('cHelmPct');
    const cWeaponsPct = document.getElementById('cWeaponsPct');
    const cSonarPct = document.getElementById('cSonarPct');
    const cEngPct = document.getElementById('cEngPct');
    const cTotal = document.getElementById('cTotal');
    const rudderOk = document.getElementById('rudderOk');
    const ballastOk = document.getElementById('ballastOk');
    const sonarOk = document.getElementById('sonarOk');
    const radioOk = document.getElementById('radioOk');
    const periscopeOk = document.getElementById('periscopeOk');
    const tubesOk = document.getElementById('tubesOk');
    mw.oninput = () => mwv.textContent = mw.value;
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }

    ws.onmessage = (ev) => {
      try { const m = JSON.parse(ev.data); if (m.topic === 'telemetry') {
        tel.textContent = JSON.stringify(m.data, null, 2);
        mwv.textContent = (m.data.reactor?.output_mw ?? 0).toFixed(0);
        mw.value = (m.data.reactor?.output_mw ?? 0);
        mwmax.textContent = (m.data.reactor?.max_mw ?? 0).toFixed(0);
        bat.textContent = (m.data.reactor?.battery_pct ?? 0).toFixed(0);
        flood.textContent = (m.data.damage?.flooding_rate ?? 0).toFixed(1);
        hull.textContent = (m.data.damage?.hull ?? 0).toFixed(2);
        const s = !!m.data.reactor?.scrammed; scramState.textContent = `SCRAM: ${s ? 'ON' : 'OFF'}`;
        // Power allocations
        const p = m.data.power || {};
        // Update current allocation labels
        if (typeof p.helm === 'number') { cHelm.value = p.helm.toFixed(2); cHelmPct.textContent = Math.round(p.helm*100) + '%'; }
        if (typeof p.weapons === 'number') { cWeapons.value = p.weapons.toFixed(2); cWeaponsPct.textContent = Math.round(p.weapons*100) + '%'; }
        if (typeof p.sonar === 'number') { cSonar.value = p.sonar.toFixed(2); cSonarPct.textContent = Math.round(p.sonar*100) + '%'; }
        if (typeof p.engineering === 'number') { cEng.value = p.engineering.toFixed(2); cEngPct.textContent = Math.round(p.engineering*100) + '%'; }
        const ct = (p.helm||0)+(p.weapons||0)+(p.sonar||0)+(p.engineering||0);
        cTotal.textContent = Math.round(ct*100) + '%';
        // Initialize proposed sliders from current if user hasn't adjusted them
        if (!pHelm.dataset.userSet) pHelm.value = (p.helm ?? 0.25).toFixed(2);
        if (!pWeapons.dataset.userSet) pWeapons.value = (p.weapons ?? 0.25).toFixed(2);
        if (!pSonar.dataset.userSet) pSonar.value = (p.sonar ?? 0.25).toFixed(2);
        if (!pEng.dataset.userSet) pEng.value = (p.engineering ?? 0.25).toFixed(2);
        updateAllocLabels();
        // Systems
        const sys = m.data.systems || {};
        const setOk = (el, ok) => { el.textContent = ok ? 'OK' : 'FAIL'; el.style.color = ok ? '#8DEB8D' : '#FF6B6B'; };
        setOk(rudderOk, !!sys.rudder_ok); setOk(ballastOk, !!sys.ballast_ok); setOk(sonarOk, !!sys.sonar_ok);
        setOk(radioOk, !!sys.radio_ok); setOk(periscopeOk, !!sys.periscope_ok); setOk(tubesOk, !!sys.tubes_ok);
        const t = m.data.task; const taskEl = document.getElementById('task'); if (t) { const color = t.stage === 'normal' ? '#FACC15' : (t.stage === 'degraded' ? '#F59E0B' : '#EF4444'); const bg = t.stage === 'normal' ? 'rgba(250, 204, 21, 0.1)' : (t.stage === 'degraded' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)'); taskEl.style.color = color; taskEl.style.borderColor = color; taskEl.style.backgroundColor = bg; taskEl.textContent = `ðŸ”§ ${t.title} â€” ${t.stage.toUpperCase()} ${(t.progress*100).toFixed(0)}% â€” time to complete ${Math.max(0, t.time_remaining_s).toFixed(0)}s${t.started ? ' (REPAIRING)' : ''}`; } else { taskEl.textContent = 'No active task'; taskEl.style.color = '#D7E3FF'; taskEl.style.borderColor = '#1B2440'; taskEl.style.backgroundColor = '#0F162A'; }
      } else if (m.topic === 'error') { showToast(m.error || 'Error'); }
      } catch(e){}
    };
    document.getElementById('set').onclick = () => ws.send(JSON.stringify({topic:'engineering.reactor.set', data:{mw: parseFloat(mw.value)}}));
    document.getElementById('scram').onclick = () => ws.send(JSON.stringify({topic:'engineering.reactor.scram', data:{scrammed:true}}));
    document.getElementById('pumpF').onclick = () => ws.send(JSON.stringify({topic:'engineering.pump.toggle', data:{pump:'fwd', enabled:true}}));
    document.getElementById('pumpA').onclick = () => ws.send(JSON.stringify({topic:'engineering.pump.toggle', data:{pump:'aft', enabled:true}}));
    function updateAllocLabels(){
      const helm = parseFloat(pHelm.value);
      const weapons = parseFloat(pWeapons.value);
      const sonar = parseFloat(pSonar.value);
      const engineering = parseFloat(pEng.value);
      const total = helm + weapons + sonar + engineering;
      pHelmPct.textContent = Math.round(helm*100) + '%';
      pWeaponsPct.textContent = Math.round(weapons*100) + '%';
      pSonarPct.textContent = Math.round(sonar*100) + '%';
      pEngPct.textContent = Math.round(engineering*100) + '%';
      pTotal.textContent = Math.round(total*100) + '%';
      pErr.textContent = total > 1.0 ? 'Exceeds 100% budget' : '';
      const un = Math.max(0, 1.0 - total);
      pUnalloc.textContent = Math.round(un*100) + '%';
    }

    ;[pHelm, pWeapons, pSonar, pEng].forEach(inp => {
      inp.addEventListener('input', () => { inp.dataset.userSet = '1'; updateAllocLabels(); });
    });

    document.getElementById('applyAlloc').onclick = () => {
      const helm = parseFloat(pHelm.value);
      const weapons = parseFloat(pWeapons.value);
      const sonar = parseFloat(pSonar.value);
      const engineering = parseFloat(pEng.value);
      const total = helm + weapons + sonar + engineering;
      if (total > 1.0){ pErr.textContent = 'Exceeds 100% budget'; showToast('Exceeds 100% budget'); return; }
      ws.send(JSON.stringify({topic:'engineering.power.allocate', data:{helm, weapons, sonar, engineering}}));
    };
    document.getElementById('repair').onclick = () => { ws.send(JSON.stringify({topic:'station.task.start', data:{station:'engineering'}})); };
  </script>
</body>
</html>
