<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sub Bridge - Fleet AI</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    h1 { font-family: ui-monospace, Menlo, monospace; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card { background:#11172B; border:1px solid #1B2440; padding:12px; border-radius:8px; }
    pre { background:#0E1326; border:1px solid #1B2440; padding:8px; border-radius:6px; color:#BBD1FF; overflow:auto; max-height: 60vh; white-space: pre-wrap; word-break: break-word; }
    #log { max-height: 60vh; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
    .row { display:flex; gap:12px; align-items:center; }
    .pill { padding:2px 8px; border-radius:999px; background:#1B2440; color:#C8D5FF; font-size:12px; }

    .debug-content.show { display:block; }
  </style>
  <script>
    let ws;
    let processedKeys = new Set();
    let lastEngines = { fleet: {engine:'stub', model:'stub'}, ship: {engine:'stub', model:'stub'} };
    function appendLog(line){
      const el = document.getElementById('log');
      const cur = el.textContent || '';
      const next = (cur ? (cur + "\n") : '') + line;
      const lines = next.split(/\n/);
      el.textContent = lines.slice(-200).join('\n');
      el.scrollTop = el.scrollHeight;
    }
    function connect(){
      ws = new WebSocket(`ws://${location.host}/ws/fleet`);
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if(msg.topic !== 'telemetry') return;
          const d = msg.data || {};
          const intent = d.fleetIntent || {};
          document.getElementById('intent').textContent = JSON.stringify(intent, null, 2);
          // Show concise summaries inline in log for quick human read
          const runs = d.aiRuns || [];
          // API call history with api_call_debug (latest 20)
          try {
            const hist = runs.slice(-20).map(r => ({
              agent: r.agent,
              at: r.at,
              ship_id: r.ship_id,
              tool_calls: r.tool_calls,
              summary: r.summary,
              api_call_debug: r.api_call_debug
            }));
            const apiEl = document.getElementById('apiHistory');
            if (apiEl) apiEl.textContent = JSON.stringify(hist, null, 2);
          } catch {}
          const engines = d.engines || {};
          const fleet = engines.fleet || {}; const ship = engines.ship || {};
          const banner = `Fleet: ${fleet.engine||'stub'} (${fleet.model||'stub'}) | Ship: ${ship.engine||'stub'} (${ship.model||'stub'})`;
          document.getElementById('engine').textContent = banner;
          lastEngines = { fleet: {engine: fleet.engine||'stub', model: fleet.model||'stub'}, ship: {engine: ship.engine||'stub', model: ship.model||'stub'} };
          for (const r of runs) {
            const key = `${r.agent||'unknown'}|${r.ship_id||''}|${r.at||''}|${(r.tool_calls&&r.tool_calls.length)||0}`;
            if (processedKeys.has(key)) continue;
            processedKeys.add(key);
            const when = r.at || new Date().toISOString();
             const prov = r.provider || 'stub';
             const mdl = r.model || 'stub';
             const ok = (r.ok === false) ? 'FAIL' : 'OK';
             const src = r.source ? ` ${r.source}` : '';
             const auto = r.autoSummary ? ' autoSummary' : '';
             if (r.agent === 'fleet') {
               const summary = r.summary ? ` | ${r.summary}` : '';
               const tool = r.tool_calls && r.tool_calls.length ? r.tool_calls[0].tool : 'no-op';
               appendLog(`${when} - fleet commander - ${tool}${summary} [${ok} ${prov}:${mdl}${src}${auto}]`);
            } else if (r.agent === 'ship') {
              const sid = r.ship_id || 'unknown';
               const summary = r.summary ? ` | ${r.summary}` : '';
               const tool = r.tool_calls && r.tool_calls.length ? r.tool_calls[0].tool : 'no-op';
               appendLog(`${when} - ${sid} - ${tool}${summary} [${ok} ${prov}:${mdl}${src}${auto}]`);
            } else if (r.agent === 'system' && r.tool_calls && r.tool_calls[0] && r.tool_calls[0].tool === 'health_check') {
              const okFleet = r.tool_calls[0].arguments && r.tool_calls[0].arguments.fleet && r.tool_calls[0].arguments.fleet.ok;
              const okShip = r.tool_calls[0].arguments && r.tool_calls[0].arguments.ship && r.tool_calls[0].arguments.ship.ok;
              appendLog(`${when} - system - health_check fleet=${okFleet?'ok':'fail'} ship=${okShip?'ok':'fail'}`);
            }
          }
        } catch {}
      };
    }

    async function healthCheck(){
      try{
        const r = await fetch(`/api/ai/health`);
        const d = await r.json();
        appendLog(`${new Date().toISOString()} - system - health_check fleet=${d.fleet && d.fleet.ok ? 'ok':'fail'} ship=${d.ship && d.ship.ok ? 'ok':'fail'}`);
      } catch {}
    }
    window.onload = () => { connect(); setTimeout(healthCheck, 500); };
  </script>
  </head>
<body>
  <h1>Fleet AI</h1>
  <div class="grid">
    <div class="card">
      <div class="row"><strong>Fleet Intent</strong><span class="pill" id="engine">loading...</span></div>
      <pre id="intent">{}</pre>
    </div>
    <div class="card">
      <strong>AI Call Log</strong>
      <pre id="log"></pre>
    </div>
  </div>
  <div class="card" style="margin-top:12px; grid-column: 1 / -1;">
    <strong>API Call History (latest 20)</strong>
    <pre id="apiHistory">[]</pre>
  </div>
</body>
</html>



