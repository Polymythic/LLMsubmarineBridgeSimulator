<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weapons</title>
  <style>
    body { background:#0B1020; color:#D7E3FF; font-family: ui-sans-serif, system-ui, -apple-system; }
    .panel { background:#11172B; border:1px solid #1B2440; padding:16px; margin:12px; border-radius:8px; }
    label { display:block; margin-top:8px; }
    input { width:100%; background:#0F162A; color:#D7E3FF; border:1px solid #1B2440; padding:8px; }
    button { margin-top:12px; padding:8px 12px; background:#26406E; border:none; color:#D7E3FF; border-radius:6px; }
    .tubes { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; }
    .tube { padding:8px; border:1px solid #1B2440; border-radius:6px; background:#0F162A; }
    .small { opacity:0.8; font-size:12px; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Weapons</h2>
    <div id="consent" title="Captain consent requirement before firing"></div>
    <div class="tubes" id="tubes" title="Tube state machine: Emptyâ†’Floodedâ†’DoorsOpen; timers show progress."></div>
    <div class="small" id="task" title="Current maintenance task for Weapons">No active task</div>
    <button id="repair" title="Start repairing the active weapons task">Repair</button>
    <label title="Select a tube to operate">Tube <input id="tube" type="number" min="1" max="6" value="1"></label>
    <div>
      <button id="load" title="Load a torpedo into the selected tube (starts reload timer)">Load</button>
      <button id="flood" title="Flood the selected tube (makes it ready to open)">Flood</button>
      <button id="doors" title="Open outer doors on the selected tube (required to fire)">Open Doors</button>
    </div>
    <label title="Set bearing to fire along">Bearing <input id="bearing" type="number" min="0" max="359" value="270"></label>
    <label title="Set commanded torpedo run depth">Run Depth <input id="rdepth" type="number" min="0" max="600" value="120"></label>
    <button id="fire" title="Fire the selected tube (interlocks apply)">Fire</button>
    <pre id="telemetry" title="Weapons telemetry and events"></pre>
  </div>
  <script>
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/weapons');
    const tel = document.getElementById('telemetry');
    const tubes = document.getElementById('tubes');
    const consent = document.getElementById('consent');
    ws.onmessage = (ev) => {
      try {
        const m = JSON.parse(ev.data);
        if (m.topic === 'telemetry') {
          tel.textContent = JSON.stringify(m.data, null, 2);
          consent.textContent = m.data.consentRequired ? `Captain consent ${m.data.captainConsent ? 'GRANTED' : 'REQUIRED'}` : 'Consent not required';
          tubes.innerHTML = '';
          (m.data.tubes || []).forEach(t => {
            const div = document.createElement('div');
            div.className = 'tube';
            const timer = t.timer_s && t.timer_s > 0 ? ` [${t.timer_s.toFixed(1)}s]` : '';
            const canFlood = t.state === 'Loaded' && (!t.timer_s || t.timer_s <= 0);
            const canDoors = t.state === 'Flooded' && (!t.timer_s || t.timer_s <= 0);
            const canFire = t.state === 'DoorsOpen' && (!t.timer_s || t.timer_s <= 0);
            div.innerHTML = `<div title='Tube state and weapon type'>Tube ${t.idx}: ${t.state} ${t.weapon ? '('+t.weapon.name+')' : ''}</div><div class='small' title='Time remaining on current transition'>Timer${timer}</div><div class='small'>Flood:${canFlood?'YES':'NO'} Doors:${canDoors?'YES':'NO'} Fire:${canFire?'YES':'NO'}</div>`;
            tubes.appendChild(div);
          });
          const taskEl = document.getElementById('task'); const task = m.data.task; if (task) { const color = task.stage === 'normal' ? '#FACC15' : (task.stage === 'degraded' ? '#F59E0B' : '#EF4444'); const bg = task.stage === 'normal' ? 'rgba(250, 204, 21, 0.1)' : (task.stage === 'degraded' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)'); taskEl.style.color = color; taskEl.style.borderColor = color; taskEl.style.backgroundColor = bg; taskEl.textContent = `ðŸ”§ ${task.title} â€” ${task.stage.toUpperCase()} ${(task.progress*100).toFixed(0)}% â€” time to complete ${Math.max(0, task.time_remaining_s).toFixed(0)}s${task.started ? ' (REPAIRING)' : ''}`; } else { taskEl.textContent = 'No active task'; taskEl.style.color = '#D7E3FF'; taskEl.style.borderColor = '#1B2440'; taskEl.style.backgroundColor = '#0F162A'; }
        }
      } catch(e){}
    };
    const tube = () => parseInt(document.getElementById('tube').value, 10);
    document.getElementById('load').onclick = () => ws.send(JSON.stringify({topic:'weapons.tube.load', data:{tube: tube(), weapon:'Mk48'}}));
    document.getElementById('flood').onclick = () => ws.send(JSON.stringify({topic:'weapons.tube.flood', data:{tube: tube()}}));
    document.getElementById('doors').onclick = () => ws.send(JSON.stringify({topic:'weapons.tube.doors', data:{tube: tube(), open:true}}));
    document.getElementById('fire').onclick = () => {
      const bearing = parseFloat(document.getElementById('bearing').value);
      const run_depth = parseFloat(document.getElementById('rdepth').value);
      ws.send(JSON.stringify({topic:'weapons.fire', data:{tube: tube(), bearing, run_depth}}));
    };
    document.getElementById('repair').onclick = () => { ws.send(JSON.stringify({topic:'station.task.start', data:{station:'weapons'}})); };
  </script>
</body>
</html>
